<div id="map_container" class="map-container"></div>

<script type="text/javascript">

	function subscribeMap(payload) {
		
 		switch (payload.option) {
 		case 'add_token':
 			if (payload.data_json != null) {
 				addMapToken(payload.data_json);
 			}
 	 		break;

 		case 'add_all_tokens':
 	 		for (map_token in payload.map_tokens) {
 	 	 		var token_id = map_token;
 	 	 		var token_name = payload.map_tokens[map_token]['token_name'];
 	 	 		var token_css_color = payload.map_tokens[map_token]['token_css_color'];
 	 	 		var token_top = payload.map_tokens[map_token]['token_top'];
 	 	 		var token_left = payload.map_tokens[map_token]['token_left'];
 	 	 		var data_json = {token_id: token_id, token_name: token_name, token_css_color: token_css_color, token_top: token_top, token_left: token_left};

 	 	 		addMapToken(data_json);
 	 	 	}

 	 	 	if (isGamemaster()) {
 	 	 		updateTokensCount();
 	 	 	}
 	 		break;

 		case 'move_token':
 			if (payload.data_json != null) {
 				moveMapToken(payload.data_json);
 			}
 	 		break;

 		case 'delete_token':
 	 		deleteMapToken(payload.token_id);
 	 		break;

 		case 'delete_all_tokens':
 			deleteAllMapTokens();
 	 		break;
 		}
 	}
 	
	$( "#map_open_panel_button" ).on('click', function() {
		if ($( ".game-container" ).css('display') == 'none') {
			$( ".game-container" ).show();
		}
		else {
			$( ".game-container" ).hide();
		}

		if ($( ".map-container" ).css('display') == 'none') {
			$( ".map-container" ).show();
		}
		else {
			$( ".map-container" ).hide();
		}
	});

	function addMapToken(data_json)
	{		
		$( "#map_container" ).append(' \
				<div id="'+data_json.token_id+'" class="map-token"> \
					<span id="map_token_name">'+data_json.token_name+'</span> \
				</div> \
			');
		$( "#map_container #"+data_json.token_id ).css("background-color", data_json.token_css_color);
		if (data_json.token_top) {
			$( "#map_container #"+data_json.token_id ).css("top", data_json.token_top);
		}
		if (data_json.token_top) {
			$( "#map_container #"+data_json.token_id ).css("left", data_json.token_left);
		}

		if (isGamemaster()) {
		    $( "#map_container #"+data_json.token_id ).draggable({
		      	scroll: false,
		      	containment: 'parent',
		   		drag: function( event, ui ) {
		   			updateZIndexMapToken(data_json.token_id);
		 	  	},
	            stop: function() {
	            	var token_id = data_json.token_id;
	                var token_top = $( this ).css('top');
	                var token_left = $( this ).css('left');
	                var new_data_json = {token_id: token_id, token_top: token_top, token_left: token_left };
	                $( "#map_container #"+token_id ).trigger( "myDraggTokenMapEvent", [ new_data_json ] );
	            }
		    });
		}
	}

	function moveMapToken(data_json)
	{
		updateZIndexMapToken(data_json.token_id);
		$( "#map_container #"+data_json.token_id ).css('top', data_json.token_top);
		$( "#map_container #"+data_json.token_id ).css('left', data_json.token_left);
	}

	function deleteAllMapTokens()
	{
		$( "#map_container .map-token" ).remove();
	}

	function deleteMapToken(token_id)
	{
		$( "#map_container #"+token_id ).remove();
	}

	var map_token_z_index_count = 0;
	function updateZIndexMapToken(token_id)
	{
		map_token_z_index_count++;
		$( "#map_container #"+token_id ).css("z-index", map_token_z_index_count);
	}



    if (isGamemaster()) {
    	$( "#map_container" ).append(' \
    		<div id="map_panel" class="map-panel"> \
    		    <input id="map_panel_text" type="text" placeholder="Name" /> \
    		    <input id="map_panel_color" type="text" placeholder="CSS color" /> \
    		    <button id="map_panel_add_token_button">Add token</button> \
    		    <button id="map_panel_delete_token_button">Delete token</button> \
    		    <button id="map_panel_delete_all_tokens_button">Delete all tokens</button> \
    		</div> \
    	');

        $( "#map_panel" ).draggable({
          	scroll: false,
          	containment: 'parent'
        });

    	var tokens_count = 0;
    	function updateTokensCount()
    	{
        	$('.map-token').each(function() {
      		  var token_id = $( this ).attr('id');
      		  if(token_id > tokens_count) 
      			  tokens_count = token_id;
    		});
    	}

    	$( "#map_container" ).on("click", "#map_panel_add_token_button", function() {
    		var token_id = parseInt(tokens_count) + 1;
    		var token_name = $(this).siblings("#map_panel_text").val();
    		var token_css_color = $(this).siblings("#map_panel_color").val();

    		var data_json = {token_id: token_id, token_name: token_name, token_css_color: token_css_color};
    		$( "#map_container" ).trigger( "myAddTokenMapEvent", [ data_json ] );
    		
    		tokens_count++;
    	});

    	var last_map_token_selected_id;
    	$( "#map_container" ).on("click", ".map-token", function() {
    		var actual_map_token_selected_id = $( this ).attr('id');
    		
    		$( this ).css("border-color", 'blue');
    		if (last_map_token_selected_id != actual_map_token_selected_id) {
    			$( "#map_container #"+last_map_token_selected_id ).css("border-color", 'black');
    		}
    		
    		last_map_token_selected_id = actual_map_token_selected_id;
    	});
    }
</script>